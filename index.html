<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ReChat Pro | Motor v5</title>
    <style>
        :root { --accent: #bc1888; --bg: #ffffff; }
        body { background: #f0f2f5; color: #1c1e21; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #fff; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; }
        .header h1 { margin: 0; font-size: 22px; background: linear-gradient(45deg, #f09433, #bc1888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: var(--bg); }
        .bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .left { background: #e4e6eb; align-self: flex-start; border-bottom-left-radius: 4px; }
        .right { background: linear-gradient(45deg, #f09433, #bc1888); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .footer { padding: 15px; background: #fff; border-top: 1px solid #ddd; text-align: center; }
        .btn { background: #000; color: #fff; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .tool-bar { background: #fff; padding: 10px; display: none; gap: 10px; justify-content: center; border-bottom: 1px solid #eee; }
        .ai-btn { background: #f0f2f5; border: 1px solid #ddd; padding: 5px 15px; border-radius: 15px; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>

<div class="header"><h1>ReChat AI Pro</h1></div>

<div class="tool-bar" id="tools">
    <button class="ai-btn" onclick="hablarIA()">ðŸ’¬ Hablar con IA</button>
    <button class="ai-btn" onclick="cambiarFondo()">ðŸŽ¨ Fondo</button>
</div>

<div id="chat-box">
    <p id="status" style="text-align:center;color:#999;margin-top:100px;">Esperando archivo JSON...</p>
</div>

<div class="footer">
    <input type="file" id="fileIn" style="display:none">
    <button class="btn" onclick="document.getElementById('fileIn').click()">CARGAR CHAT</button>
</div>

<script>
    let rawData = [];

    document.getElementById('fileIn').onchange = function(e) {
        const reader = new FileReader();
        const box = document.getElementById('chat-box');
        const status = document.getElementById('status');

        reader.onload = function(ev) {
            try {
                const json = JSON.parse(ev.target.result);
                console.log("Archivo cargado:", json);

                // BUSCADOR AGRESIVO DE MENSAJES
                let msgs = null;
                if (Array.isArray(json)) msgs = json;
                else if (json.messages) msgs = json.messages;
                else if (json.msgs) msgs = json.msgs;
                else {
                    // Si no lo encuentra, busca cualquier propiedad que sea una lista larga
                    for (let key in json) {
                        if (Array.isArray(json[key]) && json[key].length > 0) {
                            msgs = json[key];
                            break;
                        }
                    }
                }

                if (msgs && msgs.length > 0) {
                    rawData = msgs;
                    document.getElementById('tools').style.display = 'flex';
                    renderChat(msgs);
                } else {
                    // MODO DE EMERGENCIA: Muestra el texto para saber quÃ© falla
                    box.innerHTML = <h3>No se detectÃ³ formato de chat. Estructura del archivo:</h3><pre style="background:#eee;padding:10px;font-size:10px;">${JSON.stringify(json, null, 2).substring(0, 2000)}</pre>;
                }
            } catch(err) {
                box.innerHTML = "<p style='color:red;'>Error: El archivo no es un JSON vÃ¡lido.</p>";
            }
        };
        reader.readAsText(e.target.files[0]);
    };

    function renderChat(msgs) {
        const box = document.getElementById('chat-box');
        const primerNombre = msgs[0].sender_name || msgs[0].author || msgs[0].from || "Usuario A";
        
        box.innerHTML = msgs.slice(-300).map(m => {
            const nombre = m.sender_name || m.author || m.from || "Desconocido";
            const texto = m.content || m.text || m.body || m.message || "[Sin texto]";
            const esIzq = (nombre === primerNombre);
            return `<div class="bubble ${esIzq ? 'left' : 'right'}">
                        <b style="font-size:9px;opacity:0.6;">${nombre}</b><br>${texto}
                    </div>`;
        }).join('');
        box.scrollTop = box.scrollHeight;
    }

    function hablarIA() {
        const q = prompt("PregÃºntame lo que quieras (color, mÃºsica, chiste):");
        if (!q) return;
        let r = "Soy tu IA. AÃºn no tengo respuesta para eso, pero me gusta tu chat.";
        const low = q.toLowerCase();
        if (low.includes("color")) r = "Mi color favorito es el Rosa NeÃ³n.";
        if (low.includes("musica")) r = "Me encanta el Synthwave.";
        if (low.includes("chiste")) r = "Â¿QuÃ© le dice un bit a otro? ... Â¡Nos vemos en el bus!";
        alert("ðŸ¤– IA dice: " + r);
    }

    function cambiarFondo() {
        const c = prompt("Color de fondo:");
        if(c) document.documentElement.style.setProperty('--bg', c);
    }
</script>
</body>
</html>
